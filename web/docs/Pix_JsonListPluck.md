# JSON List Filter (PixNodes) - 数组处理专家

这是一个专门为处理 **JSON 对象数组**（例如 `[{"a":1}, {"a":2}]`）设计的智能过滤与重组节点。它不仅继承了【JSON对象解包器】强大的模糊匹配和语法纠错能力，还针对批处理工作流优化了数据输出格式。

## 核心特性

### 1. 深度模糊匹配 (Deep Fuzzy Match)

节点采用了与解包器同款的四层匹配算法，极大地提高了对 LLM 不规范输出的兼容性：

- **精确匹配**：`key` == `key`
- **归一化匹配**：自动忽略大小写、下划线 `_`、中划线  和空格。
    - 输入 `user name` -> 可匹配 `"user_name"`, `"UserName"`, `"USER-NAME"`。
- **深度词根匹配 (Smart Stemming)**：**[核心增强]** 智能识别单词复数形式，解决单词中间或末尾的 `s` 差异。
    - 输入 `shot_prompt` -> 完美匹配 `"shots_prompts"`, `"shot_prompts"`。
- **常见变体回退**：自动尝试匹配 `_json`, `_list`, `key_` 等常见前缀和后缀。

### 2. LLM 智能抗噪与语法修复

针对大语言模型输出的文本进行了深度抗噪处理：

- **废话过滤**：自动识别并剔除 JSON 前后的 Markdown 标记（如 ````json`）和引导性废话（如 "以下是生成的列表："）。节点会自动定位最外层的 `[` 或 `{`。
- **截断自动修复**：当 LLM 输出因 Token 限制被截断（如 `[{"a":1}, {"a":...`）时，节点会自动补全缺失的引号和闭合括号 `]` 或 `}`，尽可能挽救已生成的有效数据。
- **格式容错**：自动将 Python 风格的单引号 `'key': 'val'` 转换为标准 JSON 双引号，并处理 `True/False/None` 的转换。

### 3. 分离/合并双输出模式

- **分离模式 (默认)**：
    - **逻辑**：每行 Key 对应一个独立的输出端口。
    - **输出格式**：**纯值列表**（例如 `["值1", "值2", ""]`）。
    - **优势**：不再包裹在对象中，提取出的列表可直接传递给 KSampler、ClipTextEncode 等支持 List 输入的节点。
- **合并模式 (Merge Output)**：
    - **逻辑**：所有指定的 Key 合并到同一个对象中，通过单端口输出。
    - **输出格式**：对象数组（例如 `[{"key1": "v1", "key2": "v2"}, ...]`）。
    - **场景**：用于清洗原始 JSON，只保留需要的字段并生成新的精简 JSON 数组。

### 4. 严格的数据对齐 (Data Alignment)

- **自动占位**：在遍历数组时，如果某个对象缺失了指定的 Key，节点会自动填充空字符串 `""`。
- **长度一致性**：输出数组的长度永远等于输入数组的长度。这在 ComfyUI 批处理中至关重要，能防止因数据缺失导致的工作流错位。

## 参数详解

- **json_list_input (STRING)**
    - **输入内容**：JSON 数组字符串。支持 LLM 原始输出文本，内部会自动清理废话。
- **filter_keys (STRING)**
    - **设置方式**：多行文本框，每行输入一个 Key。
    - **默认值**：`list`
    - **占位符**：`在此输入Key，每行一个。支持模糊匹配: keys, list_keys...`
- **merge_output (BOOLEAN)**
    - **False (Separate Ports)**：开启分离模式，输出纯值列表。
    - **True (Merge to Single Port)**：开启合并模式，输出对象数组。

## 示例说明

假设输入数据为：

```
[
  {"shots_prompts": "一个现代化的客厅", "duration": 5},
  {"shots_prompts": "厨房特写", "duration": 3}
]

```

**场景 A：分离模式**
在 `filter_keys` 输入：`shot_prompt`

- **输出端口 1**：`["一个现代化的客厅", "厨房特写"]`

**场景 B：合并模式**
开启 `merge_output`，并在 `filter_keys` 输入 `shot_prompt` 和 `duration`

- **输出端口 1**：`[{"shot_prompt": "一个现代化的客厅", "duration": 5}, {"shot_prompt": "厨房特写", "duration": 3}]`

## 常见问题

**Q: 为什么分离模式输出的是 `["val"]` 而不是 `[{"key": "val"}]`？**
A: 这是为了兼容性优化。纯值列表更符合 ComfyUI 大部分节点的批量处理逻辑。如需 Key-Value 结构，请切换至合并模式。

**Q: 输入文本不是数组，而是单个对象怎么办？**
A: 节点会自动检测。如果输入的是单对象，它会将其视为只有一个元素的数组进行处理，确保逻辑不中断。