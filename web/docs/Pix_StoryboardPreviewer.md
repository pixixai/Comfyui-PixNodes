# 分镜预览

**分镜预览** 是一个专为 AIGV（AI生成视频）工作流设计的可视化节点。它能将图像、视频和文本元数据组合成直观的网格卡片，帮助创作者在一个界面内高效地检视、对比和管理分镜片段。

## 核心功能

- **自适应网格布局**：容器内的卡片会自动排列。拖动改变节点大小时，网格的列数和宽度会自动适配，确保最佳浏览体验。
- **增强型视频交互**：
    - **悬停播放**：鼠标移动到卡片媒体区域时，视频自动开始播放。
    - **精准滑动预览 (Scrubbing)**：在视频区域左右滑动鼠标，可以像非线性编辑软件一样快速拖动进度条，实时查看视频的任意帧。
    - **实时反馈**：底部显示动态进度条和精确到帧的时间码。
- **富文本元数据样式**：支持通过简单的语法自定义元数据的颜色、字号、对齐方式、粗斜体及大小写，甚至支持“块级”排版。
- **全功能本地编辑器 (HTML Export)**：
    - **离线交互**：不仅是静态图片，支持导出一个包含完整交互功能的本地 HTML 网页。
    - **数据持久化**：支持将修改后的网页“另存为”新 HTML（保留修改），或通过 JSON 导入/导出数据。
    - **实时渲染**：在导出的 HTML 中编辑元数据时，卡片样式会实时更新。
- **智能数据对齐**：节点会自动根据输入数据的数量生成卡片。
    - **优先级逻辑**：当输入长度不一致时，卡片生成的数量依据优先级：`图像批次` > `视频列表` > `JSON数据`。

## 输入参数说明

### 1. image_batch (可选)

- **类型**：`IMAGE`
- **描述**：接收图像批次（Tensor）。
- **用途**：作为分镜卡片的静态封面图。

### 2. video_list (可选)

- **类型**：`VIDEO` 或 `STRING` (列表)
- **描述**：接收视频数据。支持 ComfyUI 的 `VIDEO` 对象列表，也兼容本地视频文件的绝对路径列表。
- **用途**：提供动态预览。

### 3. shot_content_json (可选)

- **类型**：`STRING` (JSON)
- **描述**：接收 JSON 格式的字符串或对象列表。
- **用途**：显示卡片下方的元数据。支持字典格式（`键: 值`）或纯文本。支持强大的样式自定义语法。

## 元数据样式指南 (Style Syntax)

你可以在 JSON 数据的**键名 (Key)** 前添加 `[...]` 来定义样式。 语法支持**全局应用**（同时影响键和值）或**分别指定**（使用冒号 `:` 分隔）。

**基础语法**：`[规则1, 规则2] 键名`

### 1. 颜色与字号

- **颜色**：使用 Hex 代码，如 `#ff0000` (红), `#00e375` (绿)。
- **字号**：使用像素值，如 `14px`, `20px`。
- **示例**：
    - `[#ff0000] Title` -> 键名变红。
    - `[#ff0000 : #0000ff] Title` -> 键名红，值蓝。
    - `[18px] Title` -> 键名词号变大。
    - `[12px : 16px] Title` -> 键12像素，值16像素。

### 2. 对齐与布局

- **对齐**：`left`, `center`, `right`。
- **块级模式**：`block`。默认情况下，键和值在同一行（Inline）。使用 `block` 后，键会独占一行显示在值上方（类似标题与段落）。
    - **注意：在此模式下，键名后不再自动添加冒号。**
- **示例**：
    - `[center] Shot` -> 居中对齐。
    - `[block] Description` -> "Description" 在第一行（无冒号），具体内容在第二行。
    - `[block, #888 : #fff] Prompts` -> 块级排列，键灰色，值白色。

### 3. 字体样式与装饰

- **加粗**：`bold`
- **斜体**：`italic`
- **下划线**：`underline`
- **删除线**：`strike`
- **示例**：
    - `[bold] ID` -> 键名加粗。
    - `[italic : bold] ID` -> 键名斜体，值加粗。

### 4. 大小写转换

- **全大写**：`upper`
- **全小写**：`lower`
- **首字母大写**：`title`
- **示例**：
    - `[upper] uuid` -> 显示为 "UUID"。
    - `[title : upper] prompt` -> 键显示为 "Prompt"，值全大写。

### 综合示例

假设 JSON 数据为：

```
{
    "[#00e375, 14px, bold] Shot ID": "05",
    "[block, #666] Prompt": "A cinematic shot of a cyberpunk city...",
    "[right, italic] Duration": "5s"
}

```

## 交互式导出与本地编辑

### 1. 在 ComfyUI 中导出

在节点预览区域内 **点击鼠标右键**，唤出导出菜单：

- **Up (Scale)**: 设置导出图片或素材的分辨率倍率。
- **Copy Image**: 将当前视图截图复制到剪切板。
- **Save Image**: 将当前视图截图保存为 PNG。
    - **自动净化 (Clean Capture)**：
        - 截图瞬间会自动 **移除** 所有鼠标悬停的高亮效果。
        - 截图瞬间会自动 **隐藏** 视频的进度条和时间码。
        - 截图瞬间会自动 **强制显示** 视频封面图（即使当前正在播放），确保画面清晰。
- **Pack HTML**: (推荐) 自动下载包含 `index.html` 和 `assets/` 媒体文件夹的 ZIP 包，确保在任何设备上都能离线查看。

### 2. 在本地 HTML 中编辑

打开导出的 `index.html`，你会看到右侧有一个悬浮的控制面板 (Sidebar)，提供以下功能：

### 视图控制

- **Columns**: 实时调整网格列数。
- **Card Scale**: 实时调整卡片缩放比例。

### 内容编辑

- **文本修改**: 单击任意卡片打开详情预览，右侧文字区域支持直接点击修改。
    - **实时预览**：修改键名中的样式规则（如 `[color:red]`）时，背景卡片会即时更新渲染效果。
- **添加字段**: 在详情预览底部点击 `+ Add Field` 增加新的元数据。
- *(注：为保证交付稳定性，导出的 HTML 不支持添加新卡片)*

### 数据保存与迁移

- **Save HTML (Overwrite)**: 将当前的修改（文字、布局）保存为一个新的 HTML 文件。下载后覆盖原文件即可。
- **Export Metadata JSON**: 导出包含 `[rules]` 样式的原始元数据（用于备份或恢复工作）。
- **Export Clean JSON**: 导出 **去除所有样式规则** 的纯净 JSON 数据（方便交付给下游或其他软件使用）。
- **Import JSON**: 加载外部 JSON 数据更新界面。

## 常见问题

- **Q: 导出后的 HTML 中图片无法显示？**
    - A: 请确保解压了完整的 ZIP 包，并且 `index.html` 与 `assets` 文件夹在同一级目录下。
- **Q: 导出图片时视频画面是黑的？**
    - A: 导出截图基于当前 DOM 渲染。请尝试鼠标滑过视频让其加载首帧后再进行截图。